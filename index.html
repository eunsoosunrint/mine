<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì§€ë¢°ì°¾ê¸° | 10517ì •ì€ìˆ˜</title>
    <style>
        @font-face {
            font-family: 'DungGeunMo';
            src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_six@1.2/DungGeunMo.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }

        * {
            font-family: 'DungGeunMo', monospace;
        }

        td {
            display: flexbox;
            text-align: center;
            width: 1.5rem;
            height: 1.5rem;
            background-color: green;
        }
        
        td.clicked {
            background-color: lime;
        }

        td.mine {
            background-color: red;
        }

        #share {
            display: none;
        }
    </style>
</head>
<body>
    <h1>ì§€ë¢° ì°¾ê¸°</h1>
    <button onclick="document.querySelector('#finder').showModal();">ì‹œì‘í•˜ê¸°</button>
    <dialog id="finder">
        <p>ìƒíƒœ - <span id="status">ë¡œë“œì¤‘...</span></p>
        <p>íë¥¸ ì‹œê°„ - <span id="timer">ë¡œë“œì¤‘...</span></p>
        <table id="minefinder"></table>
        <br/>
        <button id="share" onclick="navigator.clipboard.writeText(share(time, clickedMine)); alert('ê²°ê³¼ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!')">ê²°ê³¼ ë³µì‚¬í•˜ê¸°</button>
    </dialog>
    <script lang="javascript">
        /**
         * JSDocsê°€ ì™œ ì•ˆë˜ëŠ”ì§€ ëª¨ë¥´ê² ìŠµë‹ˆë‹¤.
         * ì•„ë§ˆ script íƒœê·¸ ì•ˆì— ìˆì–´ì„œ ê·¸ëŸ°ê²ƒ ê°™ìŠµë‹ˆë‹¤.
         * langì„ js, javascriptë¡œ ì„¤ì •í•´ë„ ì•ˆë©ë‹ˆë‹¤.
        */
        debugger; // ë””ë²„ê±° ì˜¤í”ˆ ë§‰ìŒ

        // ê°’ ì •ì˜
        const SIZE = 8;
        const MAX_MINE = 15;
        const FINDER = document.querySelector("#minefinder");
        const TIMER = document.querySelector("#timer");
        const STATUS_VIEWER = document.querySelector("#status");
        const SHAREIT = document.querySelector("#share");
        let mines = [];
        let opened = [];
        let clickedMine;
        let time; // ë‹¨ìœ„: 10ms
        let timeKeeper;
        let status = 0; // 0= ì¤€ë¹„, 1= ì‹œì‘, 2= ìŠ¹ë¦¬, -1= íŒ¨ë°°
        let total;

        /**
         * ì§€ë¢°ì°¾ê¸°ë¥¼ ì´ˆê¸°í™” í•©ë‹ˆë‹¤.
        */
        function init() {
            if(timeKeeper) clearInterval(timeKeeper);
            time = 0;
            opened = [];

            FINDER.innerHTML = '';
            let left = MAX_MINE;
            for (let i=0; i<SIZE; i++) {
                let a = document.createElement("tr");
                for(let j = 0; j<SIZE; j++) {
                    let b= document.createElement("td");
                    // ì´ê²Œ ì§€ë¢°ê°€ ë ê²ƒì¸ì§€ ê²°ì •
                    b.setAttribute("mine", left>0 && isGonnaBeMine() ? "true" : "false");
                    if(left>0 && b.getAttribute("mine") === "true") {
                        left--;
                        mines.push({x: j, y: i});
                    }
                    b.onclick = (e) => onClick(e.target);

                    a.appendChild(b);
                }
                FINDER.append(a);
            }

            updateStatus(1);
            timeKeeper = setInterval(() => {
                updateTime(time++);
            }, 10);

            total = SIZE*SIZE-(MAX_MINE-left);

            // ë§Œì•½ì— ì§€ë¢°ê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ì„ë–„ ì¬ê·€
            if (left == MAX_MINE) init();
        }

        /**
         * í˜„ì¬ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸ í•´ì£¼ëŠ” í•¨ìˆ˜
         * 
         * @param {Number} status
        */
        async function updateStatus(newStatus) {
            status = newStatus;
            STATUS_VIEWER.innerText = newStatus === 2 ? "ìŠ¹ë¦¬" : (newStatus === -1 ? "íŒ¨ë°°" : "ì§„í–‰ì¤‘");

            if(newStatus !== 1) {
                clearInterval(timeKeeper);
                timeKeeper = undefined;
                
                SHAREIT.style.display = 'block';
                console.log(share(time, clickedMine));
            }
        }

        /**
         * íë¥¸ì‹œê°„ì„ ì—…ë°ì´íŠ¸í•´ì£¼ëŠ” í•¨ìˆ˜
         * 
         * @param {Number} ì‹œê°„ (10ms)
        */
        async function updateTime(time) {
            TIMER.innerText = formatTime(time);
        }

        /**
         * ì‹œê°„ì„ mm:ss.msë‹¨ìœ„ë¡œ í¬ë©”íŒ… í•´ì£¼ëŠ” í•¨ìˆ˜
         * 
         * @param {Number} ì‹œê°„ (10ms)
        */
        function formatTime(time) {
            const sec = parseInt(time / 100);
            const min = parseInt(sec/60);
            return zero(min)+":"+zero(sec%60)+"."+zero(time%100);
        }

        /**
         * ì•„ë¬´ë˜ë„ jsë„ %2d ê°™ì€ê²Œ í•„ìš”í•˜ë‹¤ê³  ìƒê°í•©ë‹ˆë‹¤.
         * 
         * @param {Number} í¬ë©§íŒ…í•  ê°’
        */
        function zero(n) {
            return String(n).length === 1 ? "0"+String(n) : n;
        }

        /**
         * í”Œë ˆì´ì‹œê°„ ì ˆì•½ì„ ìœ„í•œ FloodFill ë„ì…
         * 
         * @param {HTMLElement} target í´ë¦­í•œ ëŒ€ìƒ
         */
        function onClick(target) {
            if(status !== 1) return;

            let y = Array.prototype.slice.call(FINDER.children).indexOf(target.parentElement);
            let x = Array.prototype.slice.call(target.parentElement.children).indexOf(target);
            let isIt = isMine(x, y);

            opened.push({x: x, y: y});
            target.classList = isIt?"mine":"clicked";
            if(!isIt) {
                target.innerText = Math.ceil(getDistanceFromNearestMine(x, y).distance);
                if(--total === 0) updateStatus(2);
            }else {clickedMine = {x: x, y: y}; updateStatus(-1);}

            console.log(x +"/" +y);
        }

        /**
         * ì§€ë¢°ì¸ì§€ í™•ì¸
         * 
         * @param {Number} x ì‹œì‘í•  ì¢Œí‘œ X
         * @param {Number} y ì‹œì‘í•  ì¢Œí‘œ y
         * 
         * @returns {Boolean} ì§€ë¢°ì¸ì§€ ì—¬ë¶€
        */
        function isMine(x, y) {
            return FINDER.children[y].children[x].getAttribute("mine")==="true";
        }

        /**
         * ê·¼ì²˜ì— ìˆëŠ”ì§€ í™•ì¸
         * 
         * @param {Number} x ì‹œì‘í•  ì¢Œí‘œ X
         * @param {Number} y ì‹œì‘í•  ì¢Œí‘œ y
         * 
         * @returns {(Object|undefined)} ê°€ì¥ ê°€ê¹Œìš´ ì§€ë¢°ì˜ x, yì™€ ê±°ë¦¬ë¥¼ ë‹´ì€ ê°ì²´
         */
        function getDistanceFromNearestMine(x, y) {
            let nearest, nearestDistance;
            for(let mine of mines) {
                let d = getDistance(mine.x, mine.y, x, y);

                if(!nearest || !nearestDistance || nearestDistance > d) {
                    nearest = mine;
                    nearestDistance = d;
                }
            }

            if (!nearest || !nearestDistance) return undefined;

            return {
                x: nearest.x,
                y: nearest.y,
                distance: nearestDistance
            };
        }

        /**
         * ì¢Œí‘œê°„ì˜ ê±°ë¦¬
         * 
         * @param {Number} x ì¢Œí‘œ1 X
         * @param {Number} y ì¢Œí‘œ1 y
         * @param {Number} tx ì¢Œí‘œ2 X
         * @param {Number} ty ì¢Œí‘œ2 y
         * 
         * @returns {Number} ì¢Œí‘œê°„ì˜ ê±°ë¦¬
         */
        function getDistance(x, y, tx, ty) {
            return Math.sqrt(Math.abs(Math.pow(tx-x, 2) + Math.pow(ty-y, 2))); // ëŸ¬ìŠ¤íŠ¸ê°€ ê·¸ë¦¬ì›Œì§€ëŠ” ë¦¬í„´
        }

        /**
         * ì§€ë¢°ë¥¼ ì‹¬ì„ì§€ ê²°ì •
         * 
         * @returns {Boolean} ì§€ë¢°ë¥¼ ì‹¬ì„ì§€ì— ëŒ€í•œ ì—¬ë¶€
         * @ignore
        */
        function isGonnaBeMine() {
            return Math.random() < (MAX_MINE/SIZE)*.1;
        }

        /**
         * í”Œë ˆì´ì–´ê°€ ì—´ì—ˆì—ˆëŠ”ì§€ í™•ì¸
         * 
         * @param {Number} x Xì¢Œí‘œ
         * @param {Number} y Yì¢Œí‘œ
         * 
         * @returns {Boolean} í´ë¦­í–ˆì—ˆëŠ”ì§€
         */
        function isOpened(x, y) {
            for (let a of opened) {
                if(a.x==x && a.y==y) return true;
            }
            return false;
        }

        /**
         * ê³µìœ í•˜ê¸°
         * 
         * @params {Object} targetMine í´ë¦­í•œ ì§€ë¢°
         * @returns {String} ê³µìœ í•  ë¬¸ìì—´
        */
        function share(time, targetMine) {
            console.log(targetMine);
            let str = `${targetMine?"Failed":"Completed"} @ ${formatTime(time)}\n\n`;
            for(let i = 0; i<SIZE; i++) {
                for(let j = 0; j<SIZE; j++) {
                    str += isMine(j, i) ? (targetMine && targetMine.x==j && targetMine.y==i ? 'ğŸ’¥' : 'ğŸ’£') : isOpened(j, i) ? 'ğŸŸ©' : 'â¬›ï¸';
                    str += j<SIZE-1 ? " " : "";
                }
                str += '\n';
            }
            return str;
        }

        init();
    </script>
</body>
</html>